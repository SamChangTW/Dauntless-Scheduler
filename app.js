const qs=(s)=>document.querySelector(s);const fmtISO=(d)=>d.toISOString().slice(0,10);const today=new Date();today.setUTCHours(0,0,0,0);function quarterRangeFrom(d){const m=d.getUTCMonth();const y=d.getUTCFullYear();const q=Math.floor(m/3);const startM=q*3+1;const end=new Date(Date.UTC(y,startM+3-1+1,0));const start=new Date(Date.UTC(y,startM-1,1));return{start,end,label:`${start.getUTCFullYear()}/${String(startM).padStart(2,"0")} ~ ${end.getUTCFullYear()}/${String(end.getUTCMonth()+1).padStart(2,"0")}`};}function nextQuarterRange(d){const m=d.getUTCMonth(),y=d.getUTCFullYear();return quarterRangeFrom(new Date(Date.UTC(y,m+3,1)));}function sundaysBetween(a,b){const out=[],d=new Date(a);d.setUTCDate(d.getUTCDate()+((7-d.getUTCDay())%7));while(d<=b){out.push(new Date(d));d.setUTCDate(d.getUTCDate()+7);}return out;}function parseCSV(text){if(!text||!text.trim())return[];const rows=text.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,"")));const header=rows.shift().map(h=>h.trim().toLowerCase());const id=(k)=>header.indexOf(k);const iDate=id("date"),iLeague=id("league"),iStatus=id("status"),iNote=id("note"),iIsHoliday=id("is_holiday"),iHolidayName=id("holiday_name");return rows.map(r=>({date:r[iDate]||"",league:r[iLeague]||"",status:(r[iStatus]||"").toLowerCase(),note:r[iNote]||"",is_holiday:(r[iIsHoliday]||"").toLowerCase()==="true"||r[iIsHoliday]==="1",holiday_name:r[iHolidayName]||""}));}async function fetchText(url){const r=await fetch(url,{cache:"no-store"});if(!r.ok)throw new Error(r.status);return r.text();}async function loadSchedule(){return parseCSV(await fetchText(CONFIG.SHEET_URL_SCHEDULE_CSV));}async function loadHoliday(){return CONFIG.SHEET_URL_HOLIDAY_CSV?parseCSV(await fetchText(CONFIG.SHEET_URL_HOLIDAY_CSV)):[];}function renderModel(model){const{thisQ,nextQ,booked,holiday}=model;qs("#rangeThis").textContent=model.thisLabel;qs("#rangeNext").textContent=model.nextLabel;const bookedMap=new Map(booked.map(x=>[x.date,x]));const holiSet=new Set(holiday.filter(h=>h.is_holiday).map(h=>h.date));function render(container,dates){container.innerHTML="";dates.forEach(d=>{const dstr=fmtISO(d);const num=`${String(d.getUTCMonth()+1).padStart(2,"0")}/${String(d.getUTCDate()).padStart(2,"0")}`;const b=bookedMap.get(dstr);const isAvoid=holiSet.has(dstr)||(b&&b.status==="avoid");const dot=`<span class="dot ${b?"ok":(isAvoid?"bad":"")}"></span>`;const right=b?`<div><span class="badge">${b.league||"—"}</span> <span class="meta">${b.note||""}</span></div>`:(isAvoid?`<div class="meta" style="color:#ffb3a7">需避開</div>`:`<div class="meta">—</div>`);const el=document.createElement("div");el.className="slot";el.innerHTML=`<div class="d">${dot}<span class="date">${num}</span> <span class="meta">${dstr}</span></div>${right}`;el.addEventListener("click",()=>{if(dlgEditor.open&&qs("#fDate"))qs("#fDate").value=dstr;});container.appendChild(el);});}render(qs("#gridThis"),thisQ);render(qs("#gridNext"),nextQ);const setBooked=new Set(booked.filter(x=>x.status==="booked").map(x=>x.date));qs("#kpiWeeks").textContent=String(thisQ.length);qs("#kpiThisBooked").textContent=String(thisQ.filter(d=>setBooked.has(fmtISO(d))).length);qs("#kpiNextBooked").textContent=String(nextQ.filter(d=>setBooked.has(fmtISO(d))).length);const allDates=[...thisQ,...nextQ];const avoidList=computeAvoidList({allDates,booked,holiday});qs("#kpiAvoid").textContent=String(avoidList.length);window.__SUNDAYS__=allDates.map(d=>fmtISO(d));}function computeAvoidList({allDates,booked,holiday}){const bookedMap=new Map(booked.map(x=>[x.date,x]));const holiMap=new Map(holiday.filter(h=>h.is_holiday).map(h=>[h.date,h.holiday_name||"連續假期"]));const out=[];allDates.forEach(d=>{const ds=fmtISO(d);const b=bookedMap.get(ds);const h=holiMap.get(ds);if(h||(b&&(b.status==="avoid"||b.status==="booked")))out.push({date:ds,reason:h?h:(b.status==="avoid"?"需避開":`已排（${b.league||""}）`)});});return out.filter(x=>new Date(x.date+"T00:00:00Z")>=today);}function normalizeDateInput(s){if(!s)return"";s=s.trim().replace(/[.\/]/g,"-");const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);if(!m)return"";const y=m[1],mm=String(parseInt(m[2],10)).padStart(2,"0"),dd=String(parseInt(m[3],10)).padStart(2,"0");return`${y}-${mm}-${dd}`;}async function saveScheduleToCloud({date,league,status,note}){const payload={action:"addSchedule",date,league,status,note};log(`POST → API ${CONFIG.API_URL}`);const res=await fetch(CONFIG.API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const txt=await res.text().catch(()=>"(no text)");log(`← API ${res.status} ${txt}`);if(!res.ok)throw new Error("HTTP "+res.status);if(!/ok/i.test(txt))throw new Error("API 回傳非 ok");}function log(s){const box=document.getElementById("console");box.innerHTML+=s+"<br/>";}async function bootstrap(){try{log("初始化…");qs("#srcLabel").textContent="雲端";const[sched,holi]=await Promise.all([loadSchedule(),loadHoliday().catch(()=>[])]);const qThis=quarterRangeFrom(today),qNext=nextQuarterRange(today);const thisQ=sundaysBetween(qThis.start,qThis.end),nextQ=sundaysBetween(qNext.start,qNext.end);renderModel({thisQ,nextQ,booked:sched,holiday:holi,thisLabel:qThis.label,nextLabel:qNext.label});log("✔️ 讀取完成");}catch(err){log("⚠️ 讀取失敗："+err.message);alert("讀取失敗："+err.message);}}const dlgEditor=document.getElementById("dlgEditor");document.getElementById("btnOpenEditor").addEventListener("click",()=>{qs("#fDate").value="";qs("#fNote").value="";dlgEditor.showModal();});document.getElementById("btnPickSunday").addEventListener("click",()=>{const wrap=document.getElementById("inlineSundayList");wrap.innerHTML=(window.__SUNDAYS__||[]).map(d=>`<button class="chip" data-date="${d}">${d}</button>`).join("");wrap.style.display="block";wrap.querySelectorAll("button").forEach(b=>b.addEventListener("click",()=>{qs("#fDate").value=b.dataset.date;}));});document.getElementById("btnSave").addEventListener("click",async()=>{try{const raw=qs("#fDate").value||"";const norm=normalizeDateInput(raw);if(!norm){alert(`日期格式錯誤：${raw||"(空白)"}。請用 2025-11-16 或 2025/11/16`);return;}await saveScheduleToCloud({date:norm,league:qs("#fLeague").value.trim(),status:qs("#fStatus").value.trim(),note:qs("#fNote").value.trim()});alert("✅ 雲端寫入完成");dlgEditor.close();bootstrap();}catch(err){alert("寫入失敗："+err.message);log("寫入失敗："+err.message);}});document.getElementById("btnQueryAvoid").addEventListener("click",async()=>{try{const[sched,holi]=await Promise.all([loadSchedule(),loadHoliday().catch(()=>[])]);const qThis=quarterRangeFrom(today),qNext=nextQuarterRange(today);const list=computeAvoidList({allDates:[...sundaysBetween(qThis.start,qThis.end),...sundaysBetween(qNext.start,qNext.end)],booked:sched,holiday:holi});const box=document.getElementById("avoidList");box.innerHTML=list.length?list.map(x=>`<div class="slot"><div><span class="dot bad"></span><b>${x.date.slice(5).replace("-","/")}</b></div><div class="meta">${x.date} · ${x.reason}</div></div>`).join(""):'<div class="meta">兩季內沒有需避開的週日。</div>';document.getElementById("dlgAvoid").showModal();}catch(err){alert("查詢失敗："+err.message);}});document.getElementById("btnReload").addEventListener("click",()=>bootstrap());bootstrap();